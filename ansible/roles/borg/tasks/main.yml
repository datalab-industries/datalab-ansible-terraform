---
- name: Check whether ssh cert for borg exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/vaults/borg/.ssh/id_ed25519"
  register: ssh_config
  delegate_to: localhost

- name: Configure borgmatic and borg backups
  when:
    - ssh_config.stat.exists
    - borg_repository is defined
    - borg_encryption_passphrase is defined
    - borg_remote_path is defined
  block:
    - name: Synchronize borgmatic files to remote
      ansible.posix.synchronize:
        src: "{{ role_path }}/files/"
        dest: "{{ ansible_user_home_dir }}/borgmatic"

    - name: Sync local ssh config vault remote
      when: ssh_config.stat.exists
      become: true
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/vaults/borg/.ssh/"
        dest: "{{ ansible_user_home_dir }}/borgmatic/.ssh"
        mode: "0700"
        owner: root
        group: root

    - name: Render Borgmatic configuration
      become: true
      ansible.builtin.template:
        src: config.yaml.j2
        dest: "{{ ansible_user_home_dir }}/borgmatic/config.yaml"
        mode: "0600"
        owner: "{{ ansible_ssh_user }}"

      vars:
        borg_exclude_patterns:
          - /data/backups
        borg_exclude_from: []
        borg_install_method: package
        borg_user: "{{ ansible_user }}"
        borg_source_directories:
          - /data
        borgmatic_hooks:
          before_backup:
            - echo "`date` - Starting backup."
          mongodb_databases:
            - name: all
              hostname: datalab-database-1
              port: 27017
        borgmatic_timer: cron
        borg_retention_policy:
          keep_daily: 30
          keep_weekly: 0
          keep_monthly: 12
          keep_yearly: 4
        borg_one_file_system: true
        borgmatic_store_atime: true
        borgmatic_store_ctime: true
        borg_encryption_passcommand: false
        borg_remote_rate_limit: 0
        borg_ssh_command: ssh
        borg_lock_wait_time: 5

    - name: Pull borgmatic image
      become: true
      community.docker.docker_image:
        image: ghcr.io/borgmatic-collective/borgmatic:2
        source: pull
        state: present

    - name: Create borg repository if it does not exist
      community.docker.docker_container:
        image: ghcr.io/borgmatic-collective/borgmatic:2
        name: datalab-borgmatic
        volumes:
          - "{{ ansible_user_home_dir }}/borgmatic/config.yaml:/etc/borgmatic.d/config.yaml"
          - "{{ ansible_user_home_dir }}/borgmatic/.ssh:/root/.ssh"
          - /data:/data
        command: borgmatic init --encryption=repokey
        auto_remove: true

    - name: Add Cron job for borgmatic
      ansible.builtin.cron:
        name: borgmatic
        hour: "2"
        minute: "{{ range(0, 59) | random(seed=inventory_hostname) }}"
        user: "{{ ansible_user }}"
        job: docker run --rm --network datalab_backend --name datalab-borgmatic -v {{ ansible_user_home_dir }}/borgmatic/config.yaml:/etc/borgmatic.d/config.yaml -v {{ ansible_user_home_dir }}/borgmatic/.ssh:/root/.ssh -v /data:/data ghcr.io/borgmatic-collective/borgmatic:2 borgmatic -v 1 # noqa: line-length
